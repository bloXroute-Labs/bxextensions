FROM python:3.8.3-alpine3.11 as builder

ARG GID=503
ARG UID=503

RUN if [ $(grep ":${GID}:" /etc/group | wc -l) == 0 ]; then addgroup -S -g ${GID} bxextensions; fi

RUN if [ $(grep ":${UID}:" /etc/passwd | wc -l) == 0 ]; then adduser -u ${UID} -S -g ${GID} bxextensions; fi  && \
    mkdir -p /app/bxextensions && \
    chown -R ${UID}:${GID} /app/bxextensions

RUN apk update \
 && apk add --no-cache \
# grab su-exec for easy step-down from root
    'su-exec>=0.2' \
    tini \
    # grab bash for the convenience
    bash \
    # grab requirements for bxextenstions
    gcc libc-dev unixodbc-dev make \
    build-base \
    gfortran \
    python3 \
    libc6-compat \
    freetype-dev \
    openblas-dev \
    tcl \
    tk \
    python3-dev \
    pkgconfig \
    musl \
    libgfortran \
    libgcc \
    automake \
    # autogen \
    autoconf \
    libtool \
    # libtool-bin \
    openssl-dev \
    cmake \
    libexecinfo-dev

#upgrade pip
RUN pip3 install --upgrade pip setuptools

WORKDIR /app/bxextensions
RUN mkdir release/
COPY release/MANIFEST.MF release/MANIFEST.MF
COPY interface/ interface/
COPY lib/ lib/
COPY build_extensions.py ./
COPY CMakeLists.txt ./
COPY build/alpine-3.11 build/local

RUN  chown -R ${UID}:${GID} /app/bxextensions

ENV PYTHONPATH=/app/bxextensions
ENV PYTHONS="python3"

ARG TAG=latest

RUN echo "build extensions $TAG for alpine-3.11"
RUN cd /app/bxextensions && \
   PYTHON_VER=3.8 python build_extensions.py --build-type Debug --src-dir /app/bxextensions --package-installation --no-cache && \
   mkdir -p /app/bxextensions/release/lib/ && cp -r ./*.so /app/bxextensions/release/lib/


FROM scratch AS export-stage
COPY --from=builder /app/bxextensions/release/lib/ /release_tag/alpine-3.11
COPY --from=builder /app/bxextensions/build/local/ /build/alpine-3.11

