FROM ubuntu:18.04

# add our user and group first to make sure their IDs get assigned consistently, regardless of whatever dependencies get added
RUN addgroup -gid 503 -system bxextensions && \
	adduser -uid 503 -system -gid 503 bxextensions && \
	mkdir -p /app/bxextensions && \
        chown -R bxextensions:bxextensions /app/bxextensions

RUN apt update \
 &&  apt upgrade -y

RUN export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
RUN apt install -y tzdata

RUN apt install -y  \
# grab su-exec for easy step-down from root
       git \
# grab bash for the convenience
       bash \
# grab requirements for bxextenstions
       gcc libc-dev make \
       build-essential \
       gfortran \
       libfreetype6-dev \
       libopenblas-dev \
       tcl \
       tk \
       python3 \
       python3-pip \
       python3-dev \
       musl \
       automake \
       autoconf \
       libtool \
       libssl-dev \
       cmake

#upgrade pip
RUN pip3 install --upgrade pip setuptools

WORKDIR /app/bxextensions
COPY docker-entrypoint.sh /usr/local/bin/
COPY . .
RUN rm -rf build

ENV PYTHONPATH=/app/bxextensions
RUN python3 build_extensions.py --src-dir /app/bxextensions --package-installation
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
