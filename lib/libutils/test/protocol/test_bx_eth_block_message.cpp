#include <vector>
#include <gtest/gtest.h>
#include <utils/common/byte_array.h>
#include <utils/protocols/ethereum/bx_eth_block_message.h>
#include <utils/common/string_helper.h>

typedef utils::common::ByteArray ByteArray_t;
typedef utils::common::BufferView BufferView_t;
typedef utils::protocols::ethereum::BxEthBlockMessage BxEthBlockMessage_t;
typedef std::shared_ptr<std::vector<uint8_t>> PVec_t;

class BxEthBlockMessageTest : public ::testing::Test {
public:
    BufferView_t create_eth_block();
};

BufferView_t BxEthBlockMessageTest::create_eth_block(){
    std::string block_msg_str = "b80b000000000000f90badf904aaa0d7534c90736dd99f9a674b4b4d607bcdc74b5644edd944cbb5cbe501dfd547e2a027e6a4c78e2f37f80972e7b07eec43ce417c44d1983c71fc6b7b2e3c125f601794c982147bd32aede18cf676c23f65885096d801baa0f5cba017f0256f350b1c2072c6bf5023d1dc3cde283d5a2997573e3f0ea99214a0634321db212936967e7bcef31acce6f71e961deda1d6dea946492157246004e3a0f97476da7dd83c99486f0be3b42449dfd0945bb131ef8bd726c015c37ea4f61ab90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002bc070e151c23b902bc679e2a0cd64dc83a476d31abda658bdac96a319bd6bc3b6007b2150cce6c73846332ea85a90bdc60c73a495b720f12879ebdd01eee800ca2d7f35f8cc4a078623fc67894870abc0b5d7de395fd1bb49c49bd823a4f59f2d036099530ea0b48d8684fd5bfca6cefed785b0a46f3356facac4d1af19d42b8c75ff409aedc4727c2213324a5807a74055b3631cde9c38ecdc7b7a926f77c49068ff334ea343eb18b3f4d53f16f094b1cb17c9f0c931ba9d5a2cff9f63e3e44d3582e93da77e0c6460f464ca1c7b3975d4fd9c98fda22de53732da4e03537e09d8c4a917885cf8e0aa66e4f51fac600e4ee3469c277db1075d612698e9638eddde761ae28389142014dbb9085d60dceb08944fa475be2a719bf22a2e00f92d1f4be3ba4e83db5a4adb38cf3df4dae52fe205574525d2edac2c8db6218922a819bf9542e379ff291fa771664ed0d7beee4d949e3ba86f9e7c52d859a79403554758a057866a249da721361816e6423a76bf80922fc857014c179e733c88a9b291f57a9dc0a15f06d681dbe9cb88615e5617d631c652105cf063e2e265da366507f39f2d14b0479b8ad899234f99dd9556db456d6f2da9c67e3d223e4ff1ce7c041b367a57fd1cdfafdf449df95a6de01cd9060f6202890200f7a17eabd45aefde06f29d946e6cb400fe7feec94261bdeeeb8766eda93644e2104e44f92280f91887385018bc4b994b748f10c13dfcfcccc153bcfd50770138a4a20794223493da07e8186840e5c4db1f72d16832e633ef6948862a5edc343e6a136b4e5bac8f0b191d71e5c914a18ab10f43496e0ab007a4b67e0bfff66612c8449919a799c192b08ed5b61f29734845654a70dac82720dc0bcd52fab27e91d8aaee21b01408b7b1900821dec496374e24c527765830752f209fd2c49a02c31ddde52ba6c01f098ec53be269d341fd6ac0253eeb22e1cfd392886789625280b0600d353b29b336307626b70a00201a1449d1c4f845f74e3e662bed9511c2c4b14277a14ac22edf888123783fa87d6705c3c60a9c0f90129c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080c28080f905ccf902b0a09993f54ec499a51d0ef3fd34de570c57668b2853d23ce5974acb6f4e06456b44a0f8d4a5aa23be6f95bf9fee87339c90ecbdd1ada8fde260d2c0909bfe9984914a949aa073cf801e83d10f2aeae8241c058141141c49a0a30f3f282dd64297fcaa0f10ba7d5c8f8bb65d25e6c53456e6257d03d830305ba04a060aa013378b936d32193e523501c8b635ad7576f40f82d5940f4ae9677663a00d9156e2b626bf15473260bcb05245eef9d31b62a4c380ad8f908ba8eaf50663b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c8020406080ab8c8791850bd8134bdd4fc5b7276566c3aeab73c9949f020f5b63880cf92923918c2ccf506b4c0148af9d6d74fdad74d55b5778d9cc70f216ffa7ab0e1ed7c0efe4c3596c37d599af3d4209f15867f5a2dbb3f6bbe1c9e34aea2409dca309d99fe7ede0187e8a01a2dc0d8704cc6901c4790a42de201f5c8d17c2f59cd06944f4140b8da99982d1ee434365cd14745eff345da278beeb679fe0651992b4315bc162abd5604729ff19557204f95bb6ca1807ea3dc5e858e13c9460c046b101d5b3a40f2dcb3d2db71481ca0c1b2a7f9fa73820fffac433da50dfb1deae18ab1eda3777de934cd74052facc882c4a9f90316a032a9cf5161fa3284464fdb4a5784587d2b4f6856f3e4ba8ea04b1dbcd7119fdaa0b6ce36e4e831b7d2a418a9fcb93d7c8f2cd33c0c7d57228f3ffa0e20815965ac945306283f1ce13fe9aec756a8ce2be29e079c7e53a0998efabf6114d28cbb34d3e42eacf073d141df90326f7ac327fec3d7561909b4a09a6cebcb8d2156657f008b1a488c12163c469677f96b99d9709f0394b8818c37a02862a91cceafd02a1d5b07a3d66a22e128aa96f66b4c449c41aac3bf9cf4a5ebb901000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012c0306090c0fb9012c2959b4d4c35a8c26658016cb4fad6f9d81b4ab6f97be8cf97bb0d377ebd7deca4de5ad79f1c022ffb76641e9ce49f74098cfce0f617d8d76938f44ae9560f7a282472bacaeab48caced0a35967793b1227cfab1c1c49643c852b49932c39c650f5d740365304489a371839e5942a021b754ed88c1f75a4c2e736f70e7915849a3ebaec88a5b90934fc9bc02508a7c3db11a72d74350188ab162c5df7332e351825c28f3f7a0b431fd907602a242ab61cbb6cccc79c7a362ba3eb4f2a365300b672a2fcdfea1fadd790a02b4f366247e3fc4a9c197be2420b204cfa6bfc505dff78d168a78697c959982638607505be726ecd3515e60156677127a50bb4ac9fc738b30ab1695e8207dccf4bcbc04aa0c1942b649d6a501bd858c54cf0012e1e60ba50df5325455cc705dd3b46a01fa1bc8579e19ea50ceb77f1908ea1824f97a813bfc31a7ae4ccff60ba1502a48387520a831e848080630000000100000002000000030000000400000005000000060000000700000008000000090000000a0000000b0000000c0000000d0000000e0000000f000000100000001100000012000000130000001400000015000000160000001700000018000000190000001a0000001b0000001c0000001d0000001e0000001f000000200000002100000022000000230000002400000025000000260000002700000028000000290000002a0000002b0000002c0000002d0000002e0000002f000000300000003100000032000000330000003400000035000000360000003700000038000000390000003a0000003b0000003c0000003d0000003e0000003f000000400000004100000042000000430000004400000045000000460000004700000048000000490000004a0000004b0000004c0000004d0000004e0000004f000000500000005100000052000000530000005400000055000000560000005700000058000000590000005a0000005b0000005c0000005d0000005e0000005f00000060000000610000006200000063000000";
    std::vector<uint8_t> block_msg_vec;
    utils::common::from_hex_string(block_msg_str, block_msg_vec);
    return BufferView_t(&block_msg_vec.at(0), block_msg_vec.size());
}

TEST_F(BxEthBlockMessageTest, test_tx_bx_eth_block_msg) {
    BufferView_t block_buffer = create_eth_block();
    BxEthBlockMessage_t msg(block_buffer);
    msg.parse();
    ASSERT_EQ(msg.block_header().size(), 1197);
    ASSERT_EQ(utils::common::to_hex_string(msg.block_header()), "f904aaa0d7534c90736dd99f9a674b4b4d607bcdc74b5644edd944cbb5cbe501dfd547e2a027e6a4c78e2f37f80972e7b07eec43ce417c44d1983c71fc6b7b2e3c125f601794c982147bd32aede18cf676c23f65885096d801baa0f5cba017f0256f350b1c2072c6bf5023d1dc3cde283d5a2997573e3f0ea99214a0634321db212936967e7bcef31acce6f71e961deda1d6dea946492157246004e3a0f97476da7dd83c99486f0be3b42449dfd0945bb131ef8bd726c015c37ea4f61ab90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002bc070e151c23b902bc679e2a0cd64dc83a476d31abda658bdac96a319bd6bc3b6007b2150cce6c73846332ea85a90bdc60c73a495b720f12879ebdd01eee800ca2d7f35f8cc4a078623fc67894870abc0b5d7de395fd1bb49c49bd823a4f59f2d036099530ea0b48d8684fd5bfca6cefed785b0a46f3356facac4d1af19d42b8c75ff409aedc4727c2213324a5807a74055b3631cde9c38ecdc7b7a926f77c49068ff334ea343eb18b3f4d53f16f094b1cb17c9f0c931ba9d5a2cff9f63e3e44d3582e93da77e0c6460f464ca1c7b3975d4fd9c98fda22de53732da4e03537e09d8c4a917885cf8e0aa66e4f51fac600e4ee3469c277db1075d612698e9638eddde761ae28389142014dbb9085d60dceb08944fa475be2a719bf22a2e00f92d1f4be3ba4e83db5a4adb38cf3df4dae52fe205574525d2edac2c8db6218922a819bf9542e379ff291fa771664ed0d7beee4d949e3ba86f9e7c52d859a79403554758a057866a249da721361816e6423a76bf80922fc857014c179e733c88a9b291f57a9dc0a15f06d681dbe9cb88615e5617d631c652105cf063e2e265da366507f39f2d14b0479b8ad899234f99dd9556db456d6f2da9c67e3d223e4ff1ce7c041b367a57fd1cdfafdf449df95a6de01cd9060f6202890200f7a17eabd45aefde06f29d946e6cb400fe7feec94261bdeeeb8766eda93644e2104e44f92280f91887385018bc4b994b748f10c13dfcfcccc153bcfd50770138a4a20794223493da07e8186840e5c4db1f72d16832e633ef6948862a5edc343e6a136b4e5bac8f0b191d71e5c914a18ab10f43496e0ab007a4b67e0bfff66612c8449919a799c192b08ed5b61f29734845654a70dac82720dc0bcd52fab27e91d8aaee21b01408b7b1900821dec496374e24c527765830752f209fd2c49a02c31ddde52ba6c01f098ec53be269d341fd6ac0253eeb22e1cfd392886789625280b0600d353b29b336307626b70a00201a1449d1c4f845f74e3e662bed9511c2c4b14277a14ac22edf888123783fa87d6705c3c60a9c0");
    ASSERT_EQ(msg.block_hash().hex_string(), "d8ba37b20e90c75933606b35a46bccbdfe9fd9139ec9145afffd97700e3d9b3c");
    ASSERT_EQ(msg.block_trailer().size(), 1492);
}